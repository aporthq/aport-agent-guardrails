name: Secrets Scan

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  gitleaks:
    name: Scan for secrets with Gitleaks
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block builds, but report issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.2_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --report-path gitleaks-report.json --report-format json --verbose || true

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Check for secrets
        id: check_secrets
        run: |
          if [ -f gitleaks-report.json ] && [ -s gitleaks-report.json ] && [ "$(jq '. | length' gitleaks-report.json)" -gt 0 ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
            echo "⚠️ Secrets detected!"
            jq -r '.[] | "- \(.Description) in \(.File):\(.StartLine)"' gitleaks-report.json | head -20
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
            echo "✅ No secrets detected"
          fi

      - name: Comment on PR (if secrets found)
        if: steps.check_secrets.outputs.secrets_found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Secrets detected by Gitleaks!**\n\nPlease review the Gitleaks report and remove any secrets before merging.\n\nSee the workflow run for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })

  trufflehog:
    name: Scan for secrets with TruffleHog
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block builds, but report issues

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Install TruffleHog
        run: |
          curl -sSL https://github.com/trufflesecurity/trufflehog/releases/download/v3.63.5/trufflehog_3.63.5_linux_amd64.tar.gz -o trufflehog.tar.gz
          tar -xzf trufflehog.tar.gz
          sudo mv trufflehog /usr/local/bin/
          trufflehog --version

      - name: Run TruffleHog
        run: |
          trufflehog filesystem . --json --only-verified > trufflehog-report.json || true

      - name: Upload TruffleHog report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json
          retention-days: 30

      - name: Check for verified secrets
        run: |
          if [ -f trufflehog-report.json ] && [ -s trufflehog-report.json ]; then
            echo "⚠️ Verified secrets may have been detected"
            echo "Review the uploaded artifact for details"
          else
            echo "✅ No verified secrets detected"
          fi
